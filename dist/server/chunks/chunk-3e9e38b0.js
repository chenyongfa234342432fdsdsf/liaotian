import{i18n as b}from"@lingui/core";import{useState as r,useEffect as P,useRef as E}from"react";import{I as g}from"./chunk-c41c86a9.js";import f from"@nbit/arco";import{A as D,a as G,b as T}from"./chunk-0e7315a4.js";import{C as B}from"./chunk-a6cae7c5.js";import J from"react-easy-crop";import{j as a,a as i}from"./chunk-ea028b12.js";const K=n=>new Promise((t,d)=>{const o=new Image;o.addEventListener("load",()=>t(o)),o.addEventListener("error",c=>d(c)),o.setAttribute("crossOrigin","anonymous"),o.src=n});async function Q(n,t){console.log(t,"9999999999999");const d=await K(n),o=document.createElement("canvas");o.width=t.width,o.height=t.height;const c=o.getContext("2d");return c.fillStyle="#000000",c.fillRect(0,0,o.width,o.height),c.drawImage(d,t.x,t.y,t.width,t.height,0,0,t.width,t.height),new Promise((v,m)=>{o.toBlob(l=>{v(l)},"image/jpeg")})}const W="upload-avatar-with-crop-avatar-crop-module__scoped--GC-",X={scoped:W};var O,$;const{Modal:Y}=($=(O=f)==null?void 0:O.default)!=null&&$.__esModule?f.default:f;let s;function H({file:n,visible:t,onClose:d,onCommit:o,onImageChange:c}){const[v,m]=r({x:0,y:0}),[l,w]=r(1),[j,p]=r(null),[y,_]=r(""),L=e=>{m(e)},S=(e,C)=>{p(C)},R=e=>{w(e)},I=()=>{s&&clearInterval(s),d()},x=async()=>{try{const e=await Q(y,j);if(e){const C=`croppedImage_${new Date().getTime()}.jpg`,u=new File([e],C,{type:"image/jpeg"});o({croppedImage:u})}else o({croppedImage:null});s&&clearInterval(s)}catch(e){console.error(e)}},U=()=>{w(e=>e+.5)},A=()=>{l<=.5||w(e=>e-.5)},z=()=>{c()};return P(()=>{s&&clearInterval(s);let e="";return n&&(e=URL.createObjectURL(n),_(e)),()=>{e&&(URL.revokeObjectURL(e),_(""))}},[n]),P(()=>{if(n){let e="";return s=setInterval(()=>{e=URL.createObjectURL(n),_(e)},500),()=>{URL.revokeObjectURL(e),s&&clearInterval(s)}}},[n]),a(Y,{className:X.scoped,simple:!0,footer:null,style:{},title:"",visible:t,children:i("div",{className:"avatar-box",children:[i("div",{className:"avatar-top",children:[a(g,{name:"icon_chat_close",fontSize:20,className:"close-icon",onClick:I}),a("span",{className:"title-label",children:b._("components_upload_avatar_with_crop_avatar_crop_jxto5gweak")}),i("div",{className:"re-upload mr-6",onClick:z,children:[a(g,{name:"icon_register_upload",fontSize:20,className:"re-upload-icon mr-2"}),a("span",{className:"text-sm",children:b._("components_upload_avatar_with_crop_avatar_crop_ygs1rgurzb")})]})]}),a("div",{className:"crop-container",children:a(J,{image:y,crop:v,zoom:l,aspect:4/4,minZoom:.5,cropSize:{width:340,height:340},cropShape:"round",showGrid:!1,restrictPosition:!1,onCropChange:L,onCropComplete:S,onZoomChange:R})}),i("div",{className:"controls",children:[a(g,{name:"icon_set_new",fontSize:12,className:"controls-icon",onClick:U}),a(g,{name:"icon_register_photo_reduction",fontSize:12,className:"controls-icon",onClick:A})]}),a("div",{className:"commit-btn",onClick:x,children:a(g,{name:"icon_set_confirm",fontSize:24,className:"commit-icon"})})]})})}const ee="upload-avatar-with-crop-index-module__upscoped--EPL",ae={upscoped:ee};var V,Z;const{Image:oe,Spin:te,Dropdown:ne,Menu:k}=(Z=(V=f)==null?void 0:V.default)!=null&&Z.__esModule?f.default:f;function ue({oldHeadImg:n="",onHeadImgChange:t,containerClassName:d="",isGroup:o,size:c=200,padding:v=65}){const[m,l]=r(""),[w,j]=r(),p=E(null),[y,_]=r(!1),[L,S]=r(!1);E(null);const[R,I]=r(!1),x=u=>{var N;console.log("two");const h=(N=u.target.files)==null?void 0:N[0];h&&(j(h),I(!0)),p.current&&(p.current.value="")},U=()=>{p.current&&(console.log("one"),p.current.click())},A=async u=>{I(!1),_(!0);let h=await z(G.c2c,D.merchant_application,u.croppedImage);l(h.url),t(h.url),setTimeout(()=>{_(!1)},1e3)};async function z(u,h,N){return new Promise(async(M,q)=>{if(!N){M({url:""});return}T(N,u,h).then(F=>{F.url&&M(F)}).catch(()=>{q()})})}const e=()=>{I(!1)},C=()=>{l(""),t("")};return P(()=>{l(n||"")},[n]),a("div",{className:`${ae.upscoped} ${d}`,children:i(te,{loading:y,className:"avatar-box",children:[i("div",{className:"upload",children:[a(B,{size:c,padding:v,className:"headimg",src:m,isGroup:o}),a(oe.Preview,{src:m,visible:L,onVisibleChange:S}),a(ne,{droplist:i(k,{children:[m&&a(k.Item,{onClick:()=>S(!0),children:b._("components_upload_avatar_with_crop_index_msz3_ispbq")},"1"),a(k.Item,{onClick:U,children:b._("components_upload_avatar_with_crop_index_2acd25pbs7")},"3"),m&&a(k.Item,{onClick:C,children:b._("components_upload_avatar_with_crop_index_5kpqjaxtwr")},"4")]}),children:i("div",{className:"upload-icon-box",children:[a("input",{type:"file",ref:p,accept:"image/*",onChange:x,style:{display:"none"}}),a(g,{name:"icon_register_avatar",className:"upload-icon"})]})})]}),a(H,{file:w,visible:R,onClose:e,onCommit:A,onImageChange:U})]})})}export{ue as U};
