import{create as w}from"zustand";import{createTrackedSelector as O}from"react-tracked";import u from"immer";import{devtools as j,subscribeWithSelector as F}from"zustand/middleware";import{debounce as J,unionBy as L,cloneDeep as W}from"lodash";import{i18n as p}from"@lingui/core";import{Z as y,a as f}from"./chunk-61a1b424.js";import{R as k,g as D}from"./chunk-33e5f5bc.js";import g from"dayjs";import{p as T}from"./chunk-9a1033a2.js";import"./chunk-c4940547.js";import m from"@nbit/arco";import{g as Z,a as K,p as Q,b as X}from"./chunk-8d494217.js";import{f as d}from"./chunk-2fc83edf.js";import{useMemo as Y}from"react";import"./chunk-20abda34.js";var l=(e=>(e[e.NO=1]="NO",e[e.YES=2]="YES",e))(l||{});const ke=e=>k({path:"/v1/im/chat/group/create",method:"POST",data:e}),N=e=>k({path:"/v1/im/chat/group/myGroup",method:"GET",params:e}),q=e=>k({path:"/v1/im/chat/group/settingUpdate",method:"POST",data:e});function ee(e,t){return{addressBookList:[],setAddressBookList:async()=>{const s=await Z({}),{isOk:a,data:o}=s||{};a&&e(u(r=>{r.addressBookList=o}))},myGroupList:[],joinGroupList:[],setMyGroupList:async()=>{const s=await N({queryType:"1"}),{isOk:a,data:o}=s||{};a&&e(u(r=>{r.myGroupList=o}))},setJoinGroupList:async()=>{const s=await N({queryType:"2"}),{isOk:a,data:o}=s||{};a&&e(u(r=>{r.joinGroupList=o}))},remarkMap:{groupList:[],friendList:[]},setRemarkMap:s=>{e(u(a=>{a.remarkMap=s}))},groupMembers:{},setGroupMembers:(s,a)=>{e(u(o=>{o.groupMembers[s]=a}))},applyList:[],setApplyList:async()=>{const s=await K({}),{isOk:a,data:o}=s||{};a&&o&&e(u(r=>{r.applyList=o}))}}}const v=w(j(ee,{name:"address-book-store"})),E=O(v);var x,A;const{Message:se}=(A=(x=m)==null?void 0:x.default)!=null&&A.__esModule?m.default:m;function Se(e){return g().isSame(e,"day")?d(e,"HH:mm"):g().subtract(1,"day").isSame(e,"day")?p._("helper_message_0jp5jdxnde"):g().isSame(e,"year")?d(e,"MM-DD"):d(e,"YYYY-MM-DD")}function be(e){return g().isSame(e,"day")?d(e,"HH:mm"):g().subtract(1,"day").isSame(e,"day")?`${p._("helper_message_0jp5jdxnde")} ${d(e,"HH:mm")}`:g().isSame(e,"year")?d(e,"MM-DD HH:mm"):d(e,"YYYY-MM-DD HH:mm")}function Le(e){let t={};try{t=JSON.parse(e.extendedData||"{}")}catch{t.fromNickname=e.conversationID}return t}let G={};J(()=>{const e=D();Object.values(G).forEach(t=>{t[0]&&e.sendMessageReceiptsRead(t,t[0].conversationID,t[0].conversationType)}),G={}},500);async function Ne(e,t=!0){const{updateConversations:s}=b.getState(),a=D();t&&await T(p._("helper_message_fugvl05ct4"),p._("helper_message_ged1hbl6c6")),a.deleteAllMessage(e.conversationID,e.type,{isAlsoDeleteServerMessage:!0}),a.deleteConversation(e.conversationID,e.type,{isAlsoDeleteServerConversation:!0}),setTimeout(()=>{s([e],"delete")},500),t&&se.success(p._("helper_message_oqdnd_extp"))}function te(e){return e.slice().sort((s,a)=>Number(s.timestamp)-Number(a.timestamp))}var R,B;const{Message:oe}=(B=(R=m)==null?void 0:R.default)!=null&&B.__esModule?m.default:m;async function Ge(e){const{setAddressBookList:t}=v.getState();await T(p._("features_messenger_addition_index_pngdv3umj8"),p._("helper_address_book_xoexvehwmo")),(await Q({uid:Number(e)})).isOk&&(oe.success(p._("features_messenger_addition_index_t0o7celfir")),t())}function h(e,t){return(e==null?void 0:e.toString())===(t==null?void 0:t.toString())}function ne(e){const{myGroupList:t,joinGroupList:s}=v.getState();return[...t,...s].find(a=>h(a.groupId,e))}function S(e){var r,i;const{remarkMap:t,addressBookList:s}=v.getState();let a="",o="";if(e.type===y.Group){const n=ne(e.conversationID);a=((r=t.groupList.find(c=>h(c.groupId,e.conversationID)))==null?void 0:r.remark)||(n==null?void 0:n.groupRemark)||(n==null?void 0:n.groupName)||e.conversationName,o=(n==null?void 0:n.headImage)||e.conversationAvatarUrl}else{const n=s.find(c=>h(c.uid,e.conversationID));a=((i=t.friendList.find(c=>h(c.uid,e.conversationID)))==null?void 0:i.remark)||(n==null?void 0:n.friendRemark)||(n==null?void 0:n.nickName)||e.conversationName,o=(n==null?void 0:n.avatarPath)||e.conversationAvatarUrl}return{...e,conversationName:a,conversationAvatarUrl:o}}function xe(e){return E(),S(e)}function ae(e){const{addressBookList:t,myGroupList:s,joinGroupList:a}=E(),o=e.toUpperCase();return Y(()=>({friends:t.filter(r=>{var i,n;return((i=r.nickName)==null?void 0:i.toUpperCase().includes(o))||((n=r.friendRemark)==null?void 0:n.toUpperCase().includes(o))}),groups:[...s,...a].filter(r=>{var i;return r.groupName.toUpperCase().includes(o)||((i=r.groupRemark)==null?void 0:i.toUpperCase().includes(o))})}),[t,s,a,e])}function H(){const{setMyGroupList:e,setJoinGroupList:t}=v.getState();e(),t()}var P,U;const{Message:V}=(U=(P=m)==null?void 0:P.default)!=null&&U.__esModule?m.default:m;function re(e){return e.slice().sort((t,s)=>t.isPinned!==s.isPinned?t.isPinned?-1:1:t.lastMessage&&s.lastMessage?Number(s.lastMessage.timestamp)-Number(t.lastMessage.timestamp):0)}async function Ae(e){const t=e.notificationStatus===f.DoNotDisturb;await D().setConversationNotificationStatus(t?f.Notify:f.DoNotDisturb,e.conversationID,e.type),q({groupId:e.conversationID,messageDisturb:t?f.Notify:f.DoNotDisturb}).then(()=>{H()}),V.success(t?p._("helper_conversation_ilfbehxljw"):p._("helper_conversation_nyffvh3enl"))}async function Re(e){await D().updateConversationPinnedState(!e.isPinned,e.conversationID,e.type),e.type===y.Group?q({groupId:e.conversationID,isTop:e.isPinned?l.NO:l.YES}).then(()=>{H()}):X({uid:Number(e.conversationID),isTop:e.isPinned?l.NO:l.YES}).then(()=>{}),V.success(e.isPinned?p._("helper_conversation_pw8mvlwrba"):p._("helper_conversation_zzgzjhvayo"))}function z(e){return S({conversationAvatarUrl:e.avatarPath,conversationID:e.uid.toString(),conversationName:e.friendRemark||e.nickName,type:y.Peer,notificationStatus:e.messageDisturb,isPinned:e.isTop===l.YES,unreadMessageCount:0,orderKey:0})}function $(e){return S({conversationAvatarUrl:e.headImage,conversationID:e.groupId,conversationName:e.groupName,type:y.Group,notificationStatus:e.messageDisturb,isPinned:e.isTop===l.YES,unreadMessageCount:0,orderKey:0})}function Be({friend:e,group:t}){const{conversations:s,updateConversations:a,setCurrentConversation:o}=b.getState();let r=s.find(i=>i.conversationID===(e?e.uid.toString():t.groupId));if(r){o(r);return}r=e?z(e):$(t),a([r],"unshift"),o(r)}function Pe(e){const{groups:t,friends:s}=ae(e);return Y(()=>e?s.map(o=>z(o)).concat(t.map(o=>$(o))):[],[t,s])}function ie(e,t){return{imUserInfo:{userID:""},setImUserInfo:s=>{e(u(a=>{a.imUserInfo=s}))},conversations:[],updateConversations:(s,a)=>{e(u(o=>{switch(a){case"push":o.conversations.push(...s);break;case"unshift":o.conversations.unshift(...s);break;case"replace":o.conversations=s;break;case"update":s.forEach(r=>{r={...r};const i=o.conversations.findIndex(n=>n.conversationID===r.conversationID);i>-1?o.conversations.splice(i,1,r):o.conversations.unshift(r)});break;case"delete":s.forEach(r=>{const i=o.conversations.findIndex(n=>n.conversationID===r.conversationID);i>-1&&o.conversations.splice(i,1)});break}if(o.conversations=re(L(o.conversations,r=>r.conversationID)),o.currentConversation){const r=o.conversations.find(i=>i.conversationID===o.currentConversation.conversationID);r?o.currentConversation=r:o.currentConversation=void 0}}))},imIsLogin:!1,setImIsLogin:s=>e(u(a=>{a.imIsLogin=s})),imIsOnline:!1,setImIsOnline:s=>e(u(a=>{a.imIsOnline=s})),currentConversation:void 0,setCurrentConversation:s=>e(u(a=>{a.currentConversation=s})),messagesByConversation:[],updateMessagesByConversation:(s,a,o)=>e(u(r=>{const i=W(a);let n=r.messagesByConversation.find(c=>c.conversationId===s);switch(r.messagesByConversation.length>100&&r.messagesByConversation.splice(0,1),n||(n={conversationId:s,messages:[]},r.messagesByConversation.push(n)),o){case"push":n.messages.push(...i);break;case"unshift":n.messages.unshift(...i);break;case"replace":n.messages=i;break;case"update":i.forEach((c,C)=>{c={...c};function _(){return n.messages.findIndex(M=>M.messageID===c.messageID||M.localMessageID!=="0"&&M.localMessageID===c.localMessageID)}const I=_();n.messages[I],I>-1?n.messages.splice(I,1,{...c,fileLocalPath:n.messages[I].fileLocalPath}):n.messages.push(c)});break;case"delete":i.forEach(c=>{const C=n.messages.findIndex(_=>_.messageID===c.messageID);C>-1&&n.messages.splice(C,1)});break}n.messages=L(te(n.messages),c=>c.messageID)})),clearAllMessagesByConversation:()=>{e(u(s=>{s.messagesByConversation=[]}))}}}const b=w(F(j(ie,{name:"im-store"}))),Ue=O(b);export{Ue as a,v as b,ke as c,Be as d,Ge as e,be as f,N as g,Le as h,h as i,xe as j,Se as k,Ae as l,Ne as m,Pe as n,S as o,re as s,Re as t,E as u};
